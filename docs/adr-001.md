# ADR-001: Go MAML Parser Design

**Status**: Implemented

This document defines the plan for a new MAML parser in Go.

## Guiding Principles

1. **Developer Experience**: We will prioritize clear, precise error messages.
2. **Idiomatic Go**: The public API will mirror the standard `encoding` packages
   to feel familiar to Go developers.
3. **Robustness**: We will prioritize correctness and maintainability over raw
   parsing speed, as config parsing is rarely a bottleneck.

## Public API

We will copy the standard two-level API from `encoding/json` for handling both
in-memory and streaming data.

```go
// Options for configuration
type EncodeOption func(*Encoder)
type DecodeOption func(*Decoder)

// Streaming API
type Encoder struct { /* ... */ }
func NewEncoder(w io.Writer, opts ...EncodeOption) *Encoder
func (e *Encoder) Encode(v any) error

type Decoder struct { /* ... */ }
func NewDecoder(r io.Reader, opts ...DecodeOption) *Decoder
func (d *Decoder) Decode(v any) error

// In-Memory API
func Marshal(v any, opts ...EncodeOption) ([]byte, error)
func Unmarshal(data []byte, v any, opts ...DecodeOption) error
```

We will use functional options for configuration (e.g., `SetIndent(true)`).

## Internal Architecture

We will write a recursive descent parser that builds an Abstract Syntax Tree
(AST). This architecture cleanly separates concerns into three stages:

1. **Lexer (Tokenizer)**: Scans the input and converts it into a stream of
   tokens.
2. **Parser**: Consumes the token stream and builds an AST. The tree will store
   positional data (line, column) for use in error messages.
3. **Mapper**: Walks the AST to populate Go structs (using reflection) or walks
   a Go struct to build an AST for encoding.

This design makes it easier to implement other tools like linters or formatters
in the future.

## V1 Feature Set

The initial version will include:

- **Core Type Support**: `struct`, `map`, `slice`, `string`, `int`, `float64`,
  `bool`, `pointer`, and `any`.
- **Struct Tag Support**: Read `maml` struct tags for renaming (`"key_name"`),
  ignoring (`"-"`), and omitempty (`",omitempty"`).
- **Rich Error Reporting**: Return structured errors that include line and
  column numbers.
- **Configurable Indentation**: The `Encoder` will support an option for
  indented, human-readable output.

## Extensibility

We will design for extensibility from the start.

- **Custom Marshaling**: We will support two custom marshaling interfaces.

  ```go
  type MAMLMarshaler interface {
      MarshalMAML() ([]byte, error)
  }

  type MAMLUnmarshaler interface {
      UnmarshalMAML(data []byte) error
  }
  ```

  The mapper will also check for the standard `encoding.TextMarshaler` and
  `encoding.TextUnmarshaler` interfaces for compatibility with other types.

- **AST Manipulation**: We will expose the AST. This allows users to
  programmatically inspect, manipulate, or analyze MAML documents.
